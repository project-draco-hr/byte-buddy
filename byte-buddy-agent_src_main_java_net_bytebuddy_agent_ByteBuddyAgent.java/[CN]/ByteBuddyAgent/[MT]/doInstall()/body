{
  ClassLoader classLoader=new URLClassLoader(new URL[]{new URL("file:/" + System.getProperty(JAVA_HOME_PROPERTY).replace('\\','/') + TOOLS_JAR_LOCATION)},BOOTSTRAP_CLASS_LOADER);
  Class<?> virtualMachine=classLoader.loadClass(VIRTUAL_MACHINE_TYPE_NAME);
  String runtimeName=ManagementFactory.getRuntimeMXBean().getName();
  Object virtualMachineInstance=virtualMachine.getDeclaredMethod(ATTACH_METHOD_NAME,String.class).invoke(STATIC_MEMBER,runtimeName.substring(0,runtimeName.indexOf('@')));
  File agentFile=File.createTempFile(AGENT_FILE_NAME,JAR_FILE_EXTENSION);
  saveAgentJar(agentFile);
  try {
    virtualMachine.getDeclaredMethod(LOAD_AGENT_METHOD_NAME,String.class,String.class).invoke(virtualMachineInstance,agentFile.getAbsolutePath(),WITHOUT_ARGUMENTS);
    virtualMachine.getDeclaredMethod(DETACH_METHOD_NAME).invoke(virtualMachineInstance);
  }
  finally {
    if (!agentFile.delete()) {
      Logger.getAnonymousLogger().info("Cannot delete temporary file: " + agentFile);
    }
  }
}
