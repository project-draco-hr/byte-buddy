{
  TypeDescription objectType=new TypeDescription.ForLoadedType(Object.class);
  when(instrumentedType.getModifiers()).thenReturn(Opcodes.ACC_PUBLIC);
  TypeInitializer typeInitializer=mock(TypeInitializer.class);
  when(instrumentedType.getTypeInitializer()).thenReturn(typeInitializer);
  when(instrumentedType.getName()).thenReturn(BAR);
  when(instrumentedType.getInternalName()).thenReturn(BAR);
  when(instrumentedType.getStackSize()).thenReturn(StackSize.SINGLE);
  when(instrumentedType.getSupertype()).thenReturn(objectType);
  TypeList interfaceTypes=mock(TypeList.class);
  when(instrumentedType.getInterfaces()).thenReturn(interfaceTypes);
  Instrumentation.Context instrumentationContext=mock(Instrumentation.Context.class);
  MethodDescription proxyMethod=delegate.requireAccessorMethodFor(objectType.getDeclaredMethods().filter(named(TO_STRING)).getOnly(),AuxiliaryType.MethodAccessorFactory.LookupMode.Default.EXACT);
  TypeWriter.InGeneralPhase<?> typeWriter=new TypeWriter.Builder<Object>(instrumentedType,instrumentationContext,ClassFileVersion.forCurrentJavaVersion()).build(new ClassVisitorWrapper.Chain());
  TypeWriter.MethodPool constructorPool=mock(TypeWriter.MethodPool.class);
  TypeWriter.MethodPool.Entry entry=mock(TypeWriter.MethodPool.Entry.class);
  when(entry.isDefineMethod()).thenReturn(true);
  when(entry.getAttributeAppender()).thenReturn(MethodAttributeAppender.NoOp.INSTANCE);
  ByteCodeAppender superMethodCallAppender=SuperMethodCall.INSTANCE.appender(instrumentedType);
  when(entry.getByteCodeAppender()).thenReturn(superMethodCallAppender);
  when(constructorPool.target(any(MethodDescription.class))).thenReturn(entry);
  Class<?> loaded=typeWriter.methods().write(new TypeDescription.ForLoadedType(Object.class).getDeclaredMethods().filter(isConstructor()),constructorPool).write(delegate.getProxiedMethods(),delegate).make().load(getClass().getClassLoader(),ClassLoadingStrategy.Default.WRAPPER).getLoaded();
  assertThat(loaded.getName(),is(BAR));
  assertThat(loaded.getDeclaredFields().length,is(0));
  assertThat(loaded.getDeclaredMethods().length,is(1));
  assertThat(loaded.getDeclaredConstructors().length,is(1));
  Object instance=loaded.newInstance();
  Method loadedProxyMethod=loaded.getDeclaredMethods()[0];
  loadedProxyMethod.setAccessible(true);
  assertThat((String)loadedProxyMethod.invoke(instance),is(instance.toString()));
  assertThat(loadedProxyMethod.getName(),is(proxyMethod.getName()));
  assertThat(loadedProxyMethod.getModifiers(),is(proxyMethod.getModifiers()));
  verify(instrumentationContext).getRegisteredAuxiliaryTypes();
  verifyNoMoreInteractions(instrumentationContext);
}
